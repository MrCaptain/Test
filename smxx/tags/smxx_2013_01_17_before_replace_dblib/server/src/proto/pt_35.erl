%%%-----------------------------------
%%% @Module  : pt_35
%%% @Author  : csj
%%% @Created : 2010.10.05
%%% @Description: 35 多人副本
%%%-----------------------------------
-module(pt_35).
-export([read/2, write/2]).
-include("common.hrl").

%%%=========================================================================
%%% 解包函数
%%%=========================================================================
%% -----------------------------------------------------------------
%% 进入多人副本活动
%% -----------------------------------------------------------------
read(35001, _R) ->
    {ok, []};

%% -----------------------------------------------------------------
%% 退出多人副本活动
%% -----------------------------------------------------------------
read(35002, _R) ->
    {ok, []};


%% -----------------------------------------------------------------
%% 获取所有副本,给客户端在副本上创建队伍时用
%% -----------------------------------------------------------------
read(35003, _R) ->
    {ok, []};

%% -----------------------------------------------------------------
%% 创建队伍
%% -----------------------------------------------------------------
read(35004, <<DungeonId:8>>) ->
    {ok, [DungeonId]};

%% -----------------------------------------------------------------
%% 解散队伍
%% -----------------------------------------------------------------
read(35005, <<TeamId:32>>) ->
    {ok, [TeamId]};

%% -----------------------------------------------------------------
%% 加入队伍
%% -----------------------------------------------------------------
read(35006, <<DGId:8,TeamId:32>>) ->
    {ok, [DGId,TeamId]};

%% -----------------------------------------------------------------
%% 离开队伍
%% -----------------------------------------------------------------
read(35007, <<TeamId:32>>) ->
    {ok, [TeamId]};

%% -----------------------------------------------------------------
%% 查询已有队伍
%% -----------------------------------------------------------------
read(35008, _R) ->
    {ok, []};

%% -----------------------------------------------------------------
%% 查询队伍的玩家信息
%% -----------------------------------------------------------------
read(35009, <<TeamId:32>>) ->
    {ok, [TeamId]};

%% -----------------------------------------------------------------
%% 队长踢出队员
%% -----------------------------------------------------------------
read(35015, <<PlayerId:32>>) ->
    {ok, [PlayerId]};

%% -----------------------------------------------------------------
%% 队长调整队员顺序
%% -----------------------------------------------------------------
read(35017, <<UId:32,Direct:8>>) ->
    {ok, [UId,Direct]};


%% -----------------------------------------------------------------
%% 邀请玩家参加队伍
%% -----------------------------------------------------------------
read(35020, <<UID:32>>) ->
    {ok, [UID]};


%% -----------------------------------------------------------------
%% 邀请玩家参加队伍
%% -----------------------------------------------------------------
read(35023, _R) ->
    {ok, []};


%% -----------------------------------------------------------------
%% 玩家领取战斗副本
%% -----------------------------------------------------------------
read(35021, <<TeamId:32>>) ->
    {ok, [TeamId] };

%% -----------------------------------------------------------------
%% 切换副本
%% -----------------------------------------------------------------
read(35024, <<TeamId:32,DgId:8>>) ->
    {ok, [TeamId,DgId] };

%% -----------------------------------------------------------------
%% 错误处理
%% -----------------------------------------------------------------
read(_Cmd, _R) ->
    {error, no_match}.


%%%=========================================================================
%%% 组包函数
%%%=========================================================================

%% -----------------------------------------------------------------
%% 进入多人副本活动
%% -----------------------------------------------------------------
write(35001, [Code,MaxTimes,UsedTimes]) ->
    Data = <<Code:8,MaxTimes:8,UsedTimes:8>>,
    {ok, pt:pack(35001, Data)};


%% -----------------------------------------------------------------
%% 退出多人副本活动
%% -----------------------------------------------------------------
write(35002, [Code]) ->
    Data = <<Code:8>>,
    {ok, pt:pack(35002, Data)};


%% -----------------------------------------------------------------
%% 查询副本信息
%% -----------------------------------------------------------------
write(35003, [DungeonList]) ->
	Len = length(DungeonList) ,
	F = fun({DGId,DgName,DgIcon}) ->
				{NmLen,NmBin} = tool:pack_string(DgName) ,
				<<DGId:8,NmLen:16,NmBin/binary,DgIcon:32>>
		end ,
	RB = tool:to_binary([F(D) || D <- DungeonList]) ,
	{ok, pt:pack(35003, <<Len:16, RB/binary>>)};


%% -----------------------------------------------------------------
%% 创建队伍
%% -----------------------------------------------------------------
write(35004, [Code,TeamId]) ->
    {ok, pt:pack(35004, <<Code:8,TeamId:32>>)};


%% -----------------------------------------------------------------
%% 解散队伍
%% -----------------------------------------------------------------
write(35005, [Code]) ->
    Data = <<Code:8>>,
    {ok, pt:pack(35005, Data)};


%% -----------------------------------------------------------------
%% 加入队伍
%% -----------------------------------------------------------------
%% write(35006, [Code,TeamId,DgId,TeamMemList]) ->
%% 	Len = length(TeamMemList) ,
%% 	F = fun({PlayerId, PlayerName, PlayerLevel, Crr, Sex}) ->
%% 				{NmLen,NmBin} = tool:pack_string(PlayerName) ,
%% 				<<PlayerId:32, NmLen:16, NmBin/binary, PlayerLevel:8, Crr:8, Sex:8 >>
%% 		end ,
%% 	RB = tool:to_binary([F(D) || D <- TeamMemList]) ,
%%     Data = <<Code:8,TeamId:32,DgId:8,Len:16,RB/binary>>,
%%     {ok, pt:pack(35006, Data)};
write(35006, [Code,TeamId,DgId]) ->
    Data = <<Code:8,TeamId:32,DgId:8>>,
    {ok, pt:pack(35006, Data)};


%% -----------------------------------------------------------------
%% 离开队伍
%% -----------------------------------------------------------------
write(35007, [Code]) ->
    Data = <<Code:8>>,
    {ok, pt:pack(35007, Data)};



%% -----------------------------------------------------------------
%% 查询队伍
%% -----------------------------------------------------------------
write(35008, TeamList) ->
	Len = length(TeamList) ,
	F = fun({TeamId,DGId,DgName,TeamLeader,LeaderLV,CurNum,MaxNum}) ->
				{DNmLen,DNmBin} = tool:pack_string(DgName) ,
				{LNmLen,TNmBin} = tool:pack_string(TeamLeader) ,
				<<TeamId:32,DGId:8,DNmLen:16,DNmBin/binary,LNmLen:16,TNmBin/binary,LeaderLV:8,CurNum:8,MaxNum:8>>
		end ,
	RB = tool:to_binary([F(D) || D <- TeamList]),
	{ok, pt:pack(35008, <<Len:16, RB/binary>>)};



%% -----------------------------------------------------------------
%% 查询队伍玩家
%% -----------------------------------------------------------------
write(35009, [PlayerList]) ->
	Len = length(PlayerList) ,
	F = fun({PlayerId, PlayerName, PlayerLevel, Crr, Sex,Matser}) ->
				{NmLen,NmBin} = tool:pack_string(PlayerName) ,
				<<PlayerId:32, NmLen:16, NmBin/binary, PlayerLevel:8, Crr:8, Sex:8,Matser:8>>
		end ,
	RB = tool:to_binary([F(D) || D <- PlayerList]),
	{ok, pt:pack(35009, <<Len:16, RB/binary>>)};




%% -----------------------------------------------------------------
%% 实时广播新增队伍信息
%% -----------------------------------------------------------------
write(35010, [TeamId,DgId,DgName,TeamLeader,LeaderLV,CurNum,MaxNum]) ->
	{DNmLen,DNmBin} = tool:pack_string(DgName) ,
	{LNmLen,TNmBin} = tool:pack_string(TeamLeader) ,
	BinData = <<TeamId:32,DgId:8,DNmLen:16,DNmBin/binary,LNmLen:16,TNmBin/binary,LeaderLV:8,CurNum:8,MaxNum:8>>,
    {ok, pt:pack(35010, BinData)} ;



%% -----------------------------------------------------------------
%% 广播某个玩家进入队伍
%% -----------------------------------------------------------------
write(35011, [PlayerId,PlayerName,PlayerLV,Post,Crr,Sex]) ->
	{NmLen,NmBin} = tool:pack_string(PlayerName) ,
    {ok, pt:pack(35011, <<PlayerId:32,NmLen:16,NmBin/binary,PlayerLV:8, Post:8, Crr:8, Sex:8>>)};


%% -----------------------------------------------------------------
%% 广播某个玩家离开队伍 
%% -----------------------------------------------------------------
write(35012, [PlayerId,TeamId]) ->
    Data = <<PlayerId:32,TeamId:32>>,
    {ok, pt:pack(35012, Data)};

%% -----------------------------------------------------------------
%% 广播当前队伍玩家信息
%% -----------------------------------------------------------------
write(35013, [TeamId,CurMemNum]) ->
    Data = <<TeamId:32,CurMemNum:8>>,
    {ok, pt:pack(35013, Data)};


%% -----------------------------------------------------------------
%% 广播某个玩家离开队伍 
%% -----------------------------------------------------------------
write(35014, [TeamId]) ->
    Data = <<TeamId:32>>,
    {ok, pt:pack(35014, Data)};


%% -----------------------------------------------------------------
%% 踢出队员
%% -----------------------------------------------------------------
write(35015, [Code]) ->
    Data = <<Code:8>>,
    {ok, pt:pack(35015, Data)};

%% -----------------------------------------------------------------
%% 被踢消息
%% -----------------------------------------------------------------
write(35016, []) ->
    Data = <<>>,
    {ok, pt:pack(35016, Data)};

%% -----------------------------------------------------------------
%% 队长调整队员顺序
%% -----------------------------------------------------------------
write(35017, [Code]) ->
    Data = <<Code:8>>,
    {ok, pt:pack(35017, Data)};

%% -----------------------------------------------------------------
%% 被踢消息
%% -----------------------------------------------------------------
write(35018, PList) ->
	Len = length(PList) ,
	F = fun({UId,Index}) ->
				<<UId:32,Index:8>>
		end ,
	RB = tool:to_binary([F(D) || D <- PList]),
    Data = <<Len:16,RB/binary>>,
    {ok, pt:pack(35018, Data)};

%% -----------------------------------------------------------------
%% 副本的参战次数
%% -----------------------------------------------------------------
write(35019, [MaxTimes,UsedTimes]) ->
    Data = <<MaxTimes:8,UsedTimes:8>>,
    {ok, pt:pack(35019, Data)};


%% -----------------------------------------------------------------
%% 玩家领取副本战斗奖励
%% -----------------------------------------------------------------
write(35020, [Code]) ->
	Data = <<Code:8>>,
    {ok, pt:pack(35020, Data)};


%% -----------------------------------------------------------------
%% 玩家领取副本战斗奖励
%% -----------------------------------------------------------------
write(35021, [Code]) ->
	Data = <<Code:8>>,
    {ok, pt:pack(35021, Data)};



%% -----------------------------------------------------------------
%% 发送邀请给玩家
%% -----------------------------------------------------------------
write(35022, [Nick,TeamId,DgId,DgName]) ->
	{NmLen,NmBin} = tool:pack_string(Nick) ,
	{DgLen,DgBin} = tool:pack_string(DgName) ,
    Data = <<NmLen:16,NmBin/binary,TeamId:32,DgId:8,DgLen:16,DgBin/binary>>,
    {ok, pt:pack(35022, Data)};


%% -----------------------------------------------------------------
%% 玩家发快速邀请
%% -----------------------------------------------------------------
write(35023, [Code]) ->
	Data = <<Code:8>>,
    {ok, pt:pack(35023, Data)};


%% -----------------------------------------------------------------
%% 玩家切换副本
%% -----------------------------------------------------------------
write(35024, [Code]) ->
	Data = <<Code:8>>,
    {ok, pt:pack(35024, Data)};


%% -----------------------------------------------------------------
%% 玩家切换副本
%% -----------------------------------------------------------------
write(35025, [DGId,TeamId]) ->
	Data = <<DGId:8,TeamId:32>>,
    {ok, pt:pack(35025, Data)};


%% -----------------------------------------------------------------
%% 开启时间,多人副本将开启的时间
%% -----------------------------------------------------------------
write(35100, [Time]) ->
    Data = <<Time:8>>,
    {ok, pt:pack(35100, Data)};

write(Cmd, _R) ->
?INFO_MSG("~s_errorcmd_[~p] ",[misc:time_format(game_timer:now()), Cmd]),
    {ok, pt:pack(0, <<>>)}.

